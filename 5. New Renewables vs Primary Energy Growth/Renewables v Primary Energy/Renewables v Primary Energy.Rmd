---
title: "Renewables v Primary Energy Growth"
author: "by [Cormac Nolan](https://github.com/cormac85/) - `r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    code_folding: "hide"
    css: style.css
    includes: 
      after_body: footer.html
      in_header: header.html
editor_options: 
  chunk_output_type: console
---

# Introduction {.tabset .tabset-fade .tabset-pills}
> If the world is going to reduce green house gas (GHG) emissions over the coming decades by way of the current strategy of massively building out new renewables, then one thing has to happen or it will be all for nought. The rate of growth of new renewables must be greater than the growth in primary energy consumption. The alternative is self-explantory. This analysis is an attempt to answer that question, is the growth in new renewables usage greater than the growth in primary energy consumption.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if(!interactive()){
  knitr::opts_knit$set(root.dir = "..")
}

```

## Setup & Cleaning
Blah
```{r libraries, message = FALSE, warning = FALSE}
library(tidyverse)

```


```{r functions}
growth <- function(x) {(x / lag(x)) - 1}
abs_growth <- function(x) {x - lag(x)}
clean_names <- function(x) {tolower(stringr::str_replace(x, " ", "_"))}
```

Renewable energy data retrieved from the [OECD here](https://data.oecd.org/energy/renewable-energy.htm). Similarly for total primary energy [here](https://data.oecd.org/energy/primary-energy-supply.htm).

```{r import & clean 1}
primary_energy <-
  readr::read_csv("./data/raw/primary_energy.csv") %>% 
  rename_all(clean_names) %>% 
  select(-flag_codes, -frequency, -subject, -indicator) %>% 
  filter(measure == "MLN_TOE",
         !(location %in% c("G20", "EU28", "OECD", "OEU", "WLD"))) %>% 
  rename(country_iso3 = location, year = time, 
         million_tonnes_equivalent = value) %>% 
  select(-measure) 

country_codes <- readxl::read_excel("./data/raw/world_country_codes.xls")

primary_energy_clean <-
  primary_energy %>% 
  filter(year %in% 1990:2015) %>% 
  left_join(country_codes, by = c("country_iso3" = "CODE")) %>% 
  select(-X__1, -X__2) %>% 
  rename(country = Country)
  
```

We have similar issues to above in regards cleaning. If we look at the number of categories we can see most are redundant in this slice of the database we are importing. 
````{r import & clean 2}
renewable_energy <-
  readr::read_csv("./data/raw/renewable_primary_energy.csv") %>% 
  rename_all(clean_names) 

renewable_energy %>% select_if(is.character) %>% map(unique)
```

So we don't want aggregate countries like `G20` and `EU28` etc. We're only intrested in the absolute value, in this case kilo-tonnes of equivalent. The `L` lable seems to only denote missing data which we can identify easily with `NA`'s. `frequency`, `subject`. `indicator`, `flag_codes` and `measure` are all now redundant.
```{r import & clean 3}
renewable_energy <-
  renewable_energy %>% 
  select(-flag_codes, -frequency, -subject, -indicator) %>% 
  filter(measure == "KTOE",
         !(location %in% c("G20", "EU28", "OECD", "OEU", "WLD"))) %>% 
  rename(country_iso3 = location, year = time, 
         million_tonnes_equivalent = value) %>% 
  select(-measure)  %>% 
  mutate(million_tonnes_equivalent = million_tonnes_equivalent / 1000)

renewable_energy_clean<-
  renewable_energy %>% 
  filter(year %in% 1990:2015) %>% 
  left_join(country_codes, by = c("country_iso3" = "CODE")) %>% 
  select(-X__1, -X__2) %>% 
  rename(country = Country)

```

Thankfully the people at the OECD seem to have used the ISO 3-letter standard names for the countries, so we have no missing country names.
```{r}
renewable_energy_clean %>% select(country) %>% is.na() %>%
  table() %>% as_tibble() %>%  knitr::kable(caption = "Is country NA?")
```

## Exploration
### Total Primary Energy
Plotting all the data we can see some countries only have data for recent years.
```{r exploration 1, fig.cap="There appears to be some missing countries before 1990 and again 1971. 2016 is also incomplete"}
primary_energy %>% 
  ggplot(aes(year, million_tonnes_equivalent, fill = country_iso3)) +
  geom_bar(stat = "identity") +
  blorg::blog_theme +
  theme(legend.position = "none")

```

Filtering to more recent years we can get a far more complete dataset.
```{r exploration 2}
primary_energy_clean %>% 
  filter(stringr::str_detect(country, "China|United States|India")) %>% 
  ggplot(aes(year, million_tonnes_equivalent, fill = country)) +
  geom_bar(stat = "identity") +
  blorg::blog_theme

is.na(primary_energy$million_tonnes_equivalent) %>% table() %>%
  knitr::kable(caption = "Missing Data From Entire Dataset")
is.na(primary_energy_clean$million_tonnes_equivalent) %>% table() %>% 
  knitr::kable(caption = "Missing Data From 1990 Onwards")

primary_energy_clean %>% 
  filter(is.na(million_tonnes_equivalent)) %>% select(country) %>% 
  unique() %>% knitr::kable(caption = "Countries with missing data between 1990 - 2015")
```

### Renewables Primary Energy
```{r exploration 3}
renewable_energy %>% 
  ggplot(aes(year, million_tonnes_equivalent, fill = country_iso3)) +
  geom_bar(stat = "identity") +
  blorg::blog_theme +
  theme(legend.position = "none")

is.na(renewable_energy$million_tonnes_equivalent) %>% table() %>%
  knitr::kable(caption = "Missing Data From Entire Dataset")
is.na(renewable_energy_clean$million_tonnes_equivalent) %>% table() %>% 
  knitr::kable(caption = "Missing Data From 1990 Onwards")

renewable_energy_clean %>% 
  filter(is.na(million_tonnes_equivalent)) %>% select(country) %>% 
  unique() %>% knitr::kable(caption = "Countries with missing data between 1990 - 2015")
```


## Enriched Data & Further Exploration
Combining the total primary energy and renewables primary energy datasets we can then calculated the growth and absolute growth in order to make comparisons between how renewables are fairing versus the overall picture.
```{r enrichment}
primary_energy_enriched <-
  primary_energy_clean %>% 
  rename(total_mtoe = million_tonnes_equivalent) %>% 
  left_join((renewable_energy_clean %>% 
               select(year, country, million_tonnes_equivalent)), 
            by = c("country", "year")) %>% 
  rename(renewables_mtoe = million_tonnes_equivalent) %>% 
  select(-country_iso3) %>% 
  gather(energy_source, mtoe, total_mtoe, renewables_mtoe)

# Anything with "mtoe" in title will have growth calculated.
# Adding more primary energy sources to dataset should "just work"
primary_energy_enriched <-
  primary_energy_enriched %>%
  group_by(country, energy_source) %>% 
  mutate_at(vars(contains("mtoe")), 
            funs(growth = growth, abs_growth = abs_growth)) %>% 
  ungroup() 

saveRDS(primary_energy_enriched,
        "./data/processed/primary_energy_enriched.rds")
```


```{r explore enriched}
sum_growth <- function(x){ sum(growth(x), na.rm = TRUE) }
sum_abs_growth <- function(x){ sum(abs_growth(x), na.rm = TRUE) }
my_sum <- function(x){ sum(x, na.rm = TRUE)}
yearly_energy_summary <-
  primary_energy_enriched %>% 
  filter(year != 1990) %>% 
  group_by(year, energy_source) %>% 
  summarise_at(vars(contains("mtoe")), 
               funs(growth = sum_growth, abs_growth = sum_abs_growth,
                    total_mtoe = my_sum))

primary_energy_enriched %>% 
#  filter(year != 1990) %>% 
   group_by(year, energy_source) %>% 
   summarise_at(vars(contains("mtoe")), 
                funs(growth = sum(growth, na.rm = TRUE), 
                     abs_growth = sum(abs_growth, na.rm = TRUE),
                     total_mtoe = my_sum)) %>% View()

primary_energy_enriched %>% filter(energy_source == "renewables_mtoe",
                                   year %in% 1991:1992) 

primary_energy_clean %>% filter(year %in% 1991:1992) 
primary_energy %>% filter(year %in% 1991:1992) 
yearly_energy_summary %>% glimpse()

```


```{r}

```


```{r}

```


```{r}

```
