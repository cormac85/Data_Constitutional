mutate(immigrants = as.numeric(immigrants))
emm_clean <-
emmigration_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "citizen,agedef,age,unit,sex,geo\\time") %>%
separate(variable, into = c("a", "b", "c", "d", "e", "country_code"),
sep = ",") %>%
select(-a, -b, -c, -d, -e) %>%
gather(key = year, value = emmigrants, `2005`:`2016`) %>%
mutate(emmigrants = as.numeric(emmigrants))
pop_clean <-
population_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "indic_de,geo\\time") %>%
separate(variable, into = c("a", "country_code"),
sep = ",") %>%
select(-a) %>%
gather(key = year, value = population, `2006`:`2017`) %>%
mutate(population = as.numeric(population))
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(eu_codes, by = c("country_code" = "English")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population)
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(eu_codes, by = c("country_code" = "English")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population) %>% View()
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(eu_codes, by = c("country_code" = "Code")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population) %>% View()
migration_clean <-
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(eu_codes, by = c("country_code" = "Code")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population)
migration_clean <-
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(eu_codes, by = c("country_code" = "Code")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population) %>%
select(-Country_language, -French, -German)
View(eu_codes)
migration_clean$English %>% summary()
migration_clean$English %>% as.factor() %>% summary()
migration_clean <-
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(eu_codes, by = c("country_code" = "code")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population) %>%
select(-Country_language, -French, -German)
rm(imm_clean, emm_clean, pop_clean, eu_codes)
imm_clean <-
immigration_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "citizen,agedef,age,unit,sex,geo\\time") %>%
separate(variable, into = c("a", "b", "c", "d", "e", "country_code"),
sep = ",") %>%
select(-a, -b, -c, -d, -e) %>%
gather(key = year, value = immigrants, `2005`:`2016`) %>%
mutate(immigrants = as.numeric(immigrants))
emm_clean <-
emmigration_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "citizen,agedef,age,unit,sex,geo\\time") %>%
separate(variable, into = c("a", "b", "c", "d", "e", "country_code"),
sep = ",") %>%
select(-a, -b, -c, -d, -e) %>%
gather(key = year, value = emmigrants, `2005`:`2016`) %>%
mutate(emmigrants = as.numeric(emmigrants))
pop_clean <-
population_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "indic_de,geo\\time") %>%
separate(variable, into = c("a", "country_code"),
sep = ",") %>%
select(-a) %>%
gather(key = year, value = population, `2006`:`2017`) %>%
mutate(population = as.numeric(population))
View(imm_clean)
country_codes <- readr::read_csv("./data/world_country_codes.csv")
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(country_codes, by = c("country_code" = "code"))
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(country_codes, by = c("code" = "country_code"))
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(country_codes, by = c("country_code" = "a2_code")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population) %>%
select(-Country_language, -French, -German)
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(country_codes, by = c("country_code" = "a2_code")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population) %>%
select(-a3_code, -num_code)
migration_clean <-
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(country_codes, by = c("country_code" = "a2_code")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population) %>%
select(-a3_code, -num_code)
migration_clean$country
migration_clean %>% filter(is.na(country))
migration_clean %>% filter(is.na(country)) %>% View()
country_codes <- readr::read_csv("./data/world_country_codes.csv")
migration_clean <-
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(country_codes, by = c("country_code" = "a2_code")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population) %>%
select(-a3_code, -num_code)
migration_clean %>% filter(is.na(country)) %>% View()
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year"))
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year"))
View(imm_clean)
View(emm_clean)
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year"))
imm_clean %>%
inner_join(emm_clean, by = c("country_code", "year"))
imm_clean %>%
semi_join(emm_clean, by = c("country_code", "year"))
migration_clean <-
imm_clean %>%
semi_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(country_codes, by = c("country_code" = "a2_code")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population) %>%
select(-a3_code, -num_code)
imm_clean %>%
semi_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year"))
imm_clean %>%
semi_join(emm_clean, by = c("country_code", "year"))
imm_clean %>%
semi_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year"))
imm_clean %>%
semi_join(emm_clean, by = c("country_code", "year"))
imm_clean
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year"))
View(emm_clean)
pop_clean %>%
left_join(emm_clean, by = c("country_code", "year"))
immigration_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "citizen,agedef,age,unit,sex,geo\\time") %>%
separate(variable, into = c("a", "b", "c", "d", "e", "country_code"),
sep = ",") %>%
select(-a, -b, -c, -d, -e) %>%
gather(key = year, value = immigrants, `2005`:`2016`) %>%
mutate(immigrants = as.numeric(immigrants)) %>% View()
immigration_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>% View()
View(pop_clean)
imm_clean <-
immigration_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>% View()
dplyr::rename(variable = "citizen,agedef,age,unit,sex,geo\\time") %>%
separate(variable, into = c("a", "b", "c", "d", "e", "country_code"),
sep = ",") %>%
filter(b == "COMPLET") %>%
select(-a, -b, -c, -d, -e) %>%
gather(key = year, value = immigrants, `2005`:`2016`) %>%
mutate(immigrants = as.numeric(immigrants))
imm_clean <-
immigration_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "citizen,agedef,age,unit,sex,geo\\time") %>%
separate(variable, into = c("a", "b", "c", "d", "e", "country_code"),
sep = ",") %>%
filter(b == "COMPLET") %>%
select(-a, -b, -c, -d, -e) %>%
gather(key = year, value = immigrants, `2005`:`2016`) %>%
mutate(immigrants = as.numeric(immigrants))
emm_clean <-
emmigration_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "citizen,agedef,age,unit,sex,geo\\time") %>%
separate(variable, into = c("a", "b", "c", "d", "e", "country_code"),
sep = ",") %>%
filter(b == "COMPLET") %>%
select(-a, -b, -c, -d, -e) %>%
gather(key = year, value = emmigrants, `2005`:`2016`) %>%
mutate(emmigrants = as.numeric(emmigrants))
pop_clean <-
population_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "indic_de,geo\\time") %>%
separate(variable, into = c("a", "country_code"),
sep = ",") %>%
select(-a) %>%
gather(key = year, value = population, `2006`:`2017`) %>%
mutate(population = as.numeric(population))
migration_clean <-
pop_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(country_codes, by = c("country_code" = "a2_code")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population) %>%
select(-a3_code, -num_code)
pop_clean <-
population_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "indic_de,geo\\time") %>%
separate(variable, into = c("a", "country_code"),
sep = ",") %>%
select(-a) %>%
gather(key = year, value = population, `2006`:`2017`) %>%
mutate(population = as.numeric(population))
pop_clean %>%
left_join(emm_clean, by = c("country_code", "year"))
migration_clean <-
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(country_codes, by = c("country_code" = "a2_code")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population) %>%
select(-a3_code, -num_code)
rm(imm_clean, emm_clean, pop_clean, country_codes)
imm_clean <-
immigration_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "citizen,agedef,age,unit,sex,geo\\time") %>%
separate(variable, into = c("a", "b", "c", "d", "e", "country_code"),
sep = ",") %>%
filter(b == "COMPLET") %>%
select(-a, -b, -c, -d, -e) %>%
gather(key = year, value = immigrants, `2005`:`2016`) %>%
mutate(immigrants = as.numeric(immigrants))
emm_clean <-
emmigration_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "citizen,agedef,age,unit,sex,geo\\time") %>%
separate(variable, into = c("a", "b", "c", "d", "e", "country_code"),
sep = ",") %>%
filter(b == "COMPLET") %>%
select(-a, -b, -c, -d, -e) %>%
gather(key = year, value = emmigrants, `2005`:`2016`) %>%
mutate(emmigrants = as.numeric(emmigrants))
pop_clean <-
population_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "indic_de,geo\\time") %>%
separate(variable, into = c("a", "country_code"),
sep = ",") %>%
select(-a) %>%
gather(key = year, value = population, `2006`:`2017`) %>%
mutate(population = as.numeric(population))
migration_clean <-
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(country_codes, by = c("country_code" = "a2_code")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population) %>%
select(-a3_code, -num_code) %>%
filter(!(country %in% c("Bulgaria", "Belgium",
"Liechtenstein", "Romania"))) %>%
filter(year != 2005)
emmigration_raw <- readr::read_tsv("./data/tps00177_emmigration.tsv")
immigration_raw <- readr::read_tsv("./data/tps00176_immigration.tsv")
population_raw <- readr::read_tsv("./data/tps00001_population.tsv")
# Country codes are ISO standard, except for Greece
# (GR -> EL) and United Kingdom (GB -> UK).
# http://www.nationsonline.org/oneworld/country_code_list.htm
country_codes <- readr::read_csv("./data/world_country_codes.csv")
imm_clean <-
immigration_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "citizen,agedef,age,unit,sex,geo\\time") %>%
separate(variable, into = c("a", "b", "c", "d", "e", "country_code"),
sep = ",") %>%
filter(b == "COMPLET") %>%
select(-a, -b, -c, -d, -e) %>%
gather(key = year, value = immigrants, `2005`:`2016`) %>%
mutate(immigrants = as.numeric(immigrants))
emm_clean <-
emmigration_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "citizen,agedef,age,unit,sex,geo\\time") %>%
separate(variable, into = c("a", "b", "c", "d", "e", "country_code"),
sep = ",") %>%
filter(b == "COMPLET") %>%
select(-a, -b, -c, -d, -e) %>%
gather(key = year, value = emmigrants, `2005`:`2016`) %>%
mutate(emmigrants = as.numeric(emmigrants))
pop_clean <-
population_raw %>% mutate_at(.vars = vars(starts_with("2")),
.funs = stringr::str_extract,
pattern = "[0-9]+") %>%
dplyr::rename(variable = "indic_de,geo\\time") %>%
separate(variable, into = c("a", "country_code"),
sep = ",") %>%
select(-a) %>%
gather(key = year, value = population, `2006`:`2017`) %>%
mutate(population = as.numeric(population))
migration_clean <-
imm_clean %>%
left_join(emm_clean, by = c("country_code", "year")) %>%
left_join(pop_clean, by = c("country_code", "year")) %>%
left_join(country_codes, by = c("country_code" = "a2_code")) %>%
mutate(net_migration = immigrants - emmigrants,
net_migration_per_cap = net_migration / population) %>%
select(-a3_code, -num_code) %>%
filter(!(country %in% c("Bulgaria", "Belgium",
"Liechtenstein", "Romania"))) %>%
filter(year != 2005)
is.na(migration_clean)
is.na(migration_clean) %>% sum()
rm(imm_clean, emm_clean, pop_clean, country_codes)
migration_clean$country %>% unique
migration_clean %>%
group_by(year) %>%
summarise(sum_immigrants = sum(immigrants),
sum_emmigrants = sum(emmigrants),
total_population = sum(population),
total_net_migration = sum(net_migration),
mean_net_migration_per_capita = mean(net_migration_per_cap))
migration_clean %>%
group_by(year) %>%
summarise(sum_immigrants = sum(immigrants),
sum_emmigrants = sum(emmigrants),
total_population = sum(population),
total_net_migration = sum(net_migration),
mean_net_migration_per_capita = mean(net_migration_per_cap))
migration_clean %>% ungroup()
migration_clean %>%
group_by(year) %>%
summarise(sum_immigrants = sum(immigrants),
sum_emmigrants = sum(emmigrants),
total_population = sum(population),
total_net_migration = sum(net_migration),
mean_net_migration_per_capita = mean(net_migration_per_cap))
migration_clean %>%
ungroup() %>%
group_by(year) %>%
summarise(sum_immigrants = sum(immigrants),
sum_emmigrants = sum(emmigrants),
total_population = sum(population),
total_net_migration = sum(net_migration),
mean_net_migration_per_capita = mean(net_migration_per_cap))
detach(package:plyr)
migration_clean %>%
ungroup() %>%
group_by(year) %>%
summarise(sum_immigrants = sum(immigrants),
sum_emmigrants = sum(emmigrants),
total_population = sum(population),
total_net_migration = sum(net_migration),
mean_net_migration_per_capita = mean(net_migration_per_cap))
migration_year_summary <-
migration_clean %>%
group_by(year) %>%
summarise(sum_immigrants = sum(immigrants),
sum_emmigrants = sum(emmigrants),
total_population = sum(population),
total_net_migration = sum(net_migration),
mean_net_migration_per_capita = mean(net_migration_per_cap))
migration_country_summary <-
migration_clean %>%
group_by(country) %>%
summarise(sum_immigrants = sum(immigrants),
sum_emmigrants = sum(emmigrants),
total_population = sum(population),
total_net_migration = sum(net_migration),
mean_net_migration_per_capita = mean(net_migration_per_cap))
migration_country_summary
View(migration_country_summary)
migration_year_summary %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather()
migration_year_summary %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather(factor_key = year)
migration_year_summary %>%
select(year, sum_immigrants, sum_emmigrants)
migration_year_summary %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather(factor_key = "year")
migration_year_summary %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather(key = "movement_type", value = "count", factor_key = "year")
migration_year_summary %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather(key = "movement_type", value = "count", factor_key = year)
migration_year_summary %>%
select(year, sum_immigrants, sum_emmigrants)
migration_year_summary %>% ungroup() %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather(key = "movement_type", value = "count", factor_key = year)
migration_year_summary %>% ungroup() %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather(key = "movement_type", value = "count", factor_key = "year")
migration_year_summary %>% ungroup() %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather(key = "movement_type", value = "count", factor_key = "year") %>% View()
migration_year_summary %>% ungroup() %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather(key = "movement_type", value = "count", sum_immigrants:sum_emmigrants) %>% View()
migration_year_summary %>% ungroup() %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather(key = "movement_type", value = "count",
sum_immigrants:sum_emmigrants) %>%
ggplot(aes(year, movement_type)) +
geom_line() +
blorg::blog_theme
migration_year_summary %>% ungroup() %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather(key = "movement_type", value = "count",
sum_immigrants:sum_emmigrants) %>%
ggplot(aes(year, count, colour = movement_type)) +
geom_line() +
blorg::blog_theme
migration_year_summary %>% ungroup() %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather(key = "movement_type", value = "count",
sum_immigrants:sum_emmigrants) %>%
ggplot(aes(year, count, colour = movement_type, group = movement_type)) +
geom_line() +
blorg::blog_theme
migration_year_summary %>% ungroup() %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather(key = "movement_type", value = "count",
sum_immigrants:sum_emmigrants) %>%
ggplot(aes(year, count, colour = movement_type, group = movement_type)) +
geom_smooth() +
blorg::blog_theme
migration_year_summary %>% ungroup() %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather(key = "movement_type", value = "count",
sum_immigrants:sum_emmigrants) %>%
ggplot(aes(year, count, colour = movement_type, group = movement_type)) +
geom_line() +
blorg::blog_theme +
scale_colour_manual(values = blorg::blog_palette)
migration_year_summary %>% ungroup() %>%
select(year, sum_immigrants, sum_emmigrants) %>%
gather(key = "movement_type", value = "count",
sum_immigrants:sum_emmigrants) %>%
ggplot(aes(year, count, colour = movement_type, group = movement_type)) +
geom_line(size = 1.5) +
blorg::blog_theme +
scale_colour_manual(values = blorg::blog_palette)
migration_clean %>% ungroup() %>%
select(country, year, immigrants) %>%
ggplot(aes(year, immigrants, colour = country, group = country)) +
geom_line(size = 1.5) +
blorg::blog_theme +
scale_colour_manual(values = blorg::blog_palette)
migration_clean %>% ungroup() %>%
select(country, year, immigrants) %>%
ggplot(aes(year, immigrants, colour = country, group = country)) +
geom_line(size = 1.5) +
blorg::blog_theme
emmigration_raw <- readr::read_tsv("./data/tps00177_emmigration.tsv")
glimpse(migration_clean)
migration_clean$country %>% unique()
migration_clean$year %>% unique()
migration_clean %>% ungroup() %>%
select(country, year, immigrants) %>%
ggplot(aes(year, immigrants, colour = country, group = country)) +
geom_line(size = 1.5) +
blorg::blog_theme
